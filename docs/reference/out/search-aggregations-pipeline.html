<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>OpenSearch Reference</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="search-aggregations-pipeline" class="book toc2 toc-left">
<div id="header">
<h1>OpenSearch Reference</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="index.html">OpenSearch Reference</a></span></p><ul class="sectlevel1">
<li><a href="opensearch-intro.html">What is OpenSearch?</a>
</li>
<li><a href="getting-started.html">Getting started with OpenSearch</a>
</li>
<li><a href="setup.html">Set up OpenSearch</a>
</li>
<li><a href="setup-upgrade.html">Upgrade OpenSearch</a>
</li>
<li><a href="index-modules.html">Index modules</a>
</li>
<li><a href="mapping.html">Mapping</a>
</li>
<li><a href="analysis.html">Text analysis</a>
</li>
<li><a href="index-templates.html">Index templates</a>
</li>
<li><a href="ingest.html">Ingest node</a>
</li>
<li><a href="search-your-data.html">Search your data</a>
</li>
<li><a href="query-dsl.html">Query DSL</a>
</li>
<li><a href="search-aggregations.html">Aggregations</a>
<ul class="sectlevel1">
<li><a href="search-aggregations-bucket.html">Bucket aggregations</a>
</li>
<li><a href="search-aggregations-metrics.html">Metrics aggregations</a>
</li>
<li><a href="search-aggregations-pipeline.html"><span class="toc-current">Pipeline aggregations</span></a>
<ul class="sectlevel2">
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-avg-bucket-aggregation">Avg bucket aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-bucket-script-aggregation">Bucket script aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-bucket-selector-aggregation">Bucket selector aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-bucket-sort-aggregation">Bucket sort aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-cumulative-sum-aggregation">Cumulative sum aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-derivative-aggregation">Derivative aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-extended-stats-bucket-aggregation">Extended stats bucket aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-max-bucket-aggregation">Max bucket aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-min-bucket-aggregation">Min bucket aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-movavg-aggregation">Moving average aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-movfn-aggregation">Moving function aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-percentiles-bucket-aggregation">Percentiles bucket aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-serialdiff-aggregation">Serial differencing aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-stats-bucket-aggregation">Stats bucket aggregation</a>
</li>
<li><a href="search-aggregations-pipeline.html#search-aggregations-pipeline-sum-bucket-aggregation">Sum bucket aggregation</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="modules-scripting.html">Scripting</a>
</li>
<li><a href="high-availability.html">Set up a cluster for high availability</a>
</li>
<li><a href="snapshot-restore.html">Snapshot and restore</a>
</li>
<li><a href="commands.html">Command line tools</a>
</li>
<li><a href="how-to.html">How To</a>
</li>
<li><a href="glossary.html">Glossary of terms</a>
</li>
<li><a href="rest-apis.html">REST APIs</a>
</li>
<li><a href="breaking-changes.html">Migration guide</a>
</li>
<li><a href="opensearch-release-notes.html">Release notes</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="search-aggregations-pipeline">Pipeline aggregations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pipeline aggregations work on the outputs produced from other aggregations rather than from document sets, adding
information to the output tree. There are many different types of pipeline aggregation, each computing different information from
other aggregations, but these types can be broken down into two families:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Parent</em></dt>
<dd>
<p>A family of pipeline aggregations that is provided with the output of its parent aggregation and is able
to compute new buckets or new aggregations to add to existing buckets.</p>
</dd>
<dt class="hdlist1"><em>Sibling</em></dt>
<dd>
<p>Pipeline aggregations that are provided with the output of a sibling aggregation and are able to compute a
new aggregation which will be at the same level as the sibling aggregation.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Pipeline aggregations can reference the aggregations they need to perform their computation by using the <code>buckets_path</code>
parameter to indicate the paths to the required metrics. The syntax for defining these paths can be found in the
<a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> section below.</p>
</div>
<div class="paragraph">
<p>Pipeline aggregations cannot have sub-aggregations but depending on the type it can reference another pipeline in the <code>buckets_path</code>
allowing pipeline aggregations to be chained.  For example, you can chain together two derivatives to calculate the second derivative
(i.e. a derivative of a derivative).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Because pipeline aggregations only add to the output, when chaining pipeline aggregations the output of each pipeline aggregation
will be included in the final output.
</td>
</tr>
</table>
</div>
<h3 id="buckets-path-syntax" class="discrete"><code>buckets_path</code> Syntax</h3>
<div class="paragraph">
<p>Most pipeline aggregations require another aggregation as their input.  The input aggregation is defined via the <code>buckets_path</code>
parameter, which follows a specific format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">AGG_SEPARATOR       =  `&gt;` ;
METRIC_SEPARATOR    =  `.` ;
AGG_NAME            =  &lt;the name of the aggregation&gt; ;
METRIC              =  &lt;the name of the metric (in case of multi-value metrics aggregation)&gt; ;
MULTIBUCKET_KEY     =  `[&lt;KEY_NAME&gt;]`
PATH                =  &lt;AGG_NAME&gt;&lt;MULTIBUCKET_KEY&gt;? (&lt;AGG_SEPARATOR&gt;, &lt;AGG_NAME&gt; )* ( &lt;METRIC_SEPARATOR&gt;, &lt;METRIC&gt; ) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, the path <code>"my_bucket&gt;my_stats.avg"</code> will path to the <code>avg</code> value in the <code>"my_stats"</code> metric, which is
contained in the <code>"my_bucket"</code> bucket aggregation.</p>
</div>
<div class="paragraph">
<p>Paths are relative from the position of the pipeline aggregation; they are not absolute paths, and the path cannot go back "up" the
aggregation tree. For example, this moving average is embedded inside a date_histogram and refers to a "sibling"
metric <code>"the_sum"</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "lemmings" } <b class="conum">(1)</b>
        },
        "the_movavg": {
          "moving_avg": { "buckets_path": "the_sum" } <b class="conum">(2)</b>
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The metric is called <code>"the_sum"</code></p>
</li>
<li>
<p>The <code>buckets_path</code> refers to the metric via a relative path <code>"the_sum"</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>buckets_path</code> is also used for Sibling pipeline aggregations, where the aggregation is "next" to a series of buckets
instead of embedded "inside" them.  For example, the <code>max_bucket</code> aggregation uses the <code>buckets_path</code> to specify
a metric embedded inside a sibling aggregation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "max_monthly_sales": {
      "max_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <b class="conum">(1)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this max_bucket aggregation that we want the maximum value of the <code>sales</code> aggregation in the
<code>sales_per_month</code> date histogram.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If a Sibling pipeline agg references a multi-bucket aggregation, such as a <code>terms</code> agg, it also has the option to
select specific keys from the multi-bucket.  For example, a <code>bucket_script</code> could select two specific buckets (via
their bucket keys) to perform the calculation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sale_type": {
          "terms": {
            "field": "type"
          },
          "aggs": {
            "sales": {
              "sum": {
                "field": "price"
              }
            }
          }
        },
        "hat_vs_bag_ratio": {
          "bucket_script": {
            "buckets_path": {
              "hats": "sale_type['hat']&gt;sales",   <b class="conum">(1)</b>
              "bags": "sale_type['bag']&gt;sales"    <b class="conum">(1)</b>
            },
            "script": "params.hats / params.bags"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> selects the hats and bags buckets (via <code>['hat']</code>/<code>['bag']`</code>) to use in the script specifically,
instead of fetching all the buckets from <code>sale_type</code> aggregation</p>
</li>
</ol>
</div>
<h3 id="_special_paths" class="discrete">Special Paths</h3>
<div class="paragraph">
<p>Instead of pathing to a metric, <code>buckets_path</code> can use a special <code>"_count"</code> path.  This instructs
the pipeline aggregation to use the document count as its input.  For example, a moving average can be calculated on the document count of each bucket, instead of a specific metric:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "day"
      },
      "aggs": {
        "the_movavg": {
          "moving_avg": { "buckets_path": "_count" } <b class="conum">(1)</b>
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>By using <code>_count</code> instead of a metric name, we can calculate the moving average of document counts in the histogram</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>buckets_path</code> can also use <code>"_bucket_count"</code> and path to a multi-bucket aggregation to use the number of buckets
returned by that aggregation in the pipeline aggregation instead of a metric. for example a <code>bucket_selector</code> can be
used here to filter out buckets which contain no buckets for an inner terms aggregation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "day"
      },
      "aggs": {
        "categories": {
          "terms": {
            "field": "category"
          }
        },
        "min_bucket_selector": {
          "bucket_selector": {
            "buckets_path": {
              "count": "categories._bucket_count" <b class="conum">(1)</b>
            },
            "script": {
              "source": "params.count != 0"
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>By using <code>_bucket_count</code> instead of a metric name, we can filter out <code>histo</code> buckets where they contain no buckets
for the <code>categories</code> aggregation</p>
</li>
</ol>
</div>
<h3 id="dots-in-agg-names" class="discrete">Dealing with dots in agg names</h3>
<div class="paragraph">
<p>An alternate syntax is supported to cope with aggregations or metrics which
have dots in the name, such as the 99.9th
<a href="search-aggregations-metrics.html#search-aggregations-metrics-percentile-aggregation">percentile</a>. This metric
may be referred to as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">"buckets_path": "my_percentile[99.9]"</code></pre>
</div>
</div>
<h3 id="gap-policy" class="discrete">Dealing with gaps in the data</h3>
<div class="paragraph">
<p>Data in the real world is often noisy and sometimes contains <strong>gaps</strong>&#8201;&#8212;&#8201;places where data simply doesn&#8217;t exist.  This can
occur for a variety of reasons, the most common being:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Documents falling into a bucket do not contain a required field</p>
</li>
<li>
<p>There are no documents matching the query for one or more buckets</p>
</li>
<li>
<p>The metric being calculated is unable to generate a value, likely because another dependent bucket is missing a value.
Some pipeline aggregations have specific requirements that must be met (e.g. a derivative cannot calculate a metric for the
first value because there is no previous value, HoltWinters moving average need "warmup" data to begin calculating, etc)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Gap policies are a mechanism to inform the pipeline aggregation about the desired behavior when "gappy" or missing
data is encountered.  All pipeline aggregations accept the <code>gap_policy</code> parameter.  There are currently two gap policies
to choose from:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>skip</em></dt>
<dd>
<p>This option treats missing data as if the bucket does not exist.  It will skip the bucket and continue
calculating using the next available value.</p>
</dd>
<dt class="hdlist1"><em>insert_zeros</em></dt>
<dd>
<p>This option will replace missing values with a zero (<code>0</code>) and pipeline aggregation computation will
proceed as normal.</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-avg-bucket-aggregation">Avg bucket aggregation</h3>
<titleabbrev>Avg bucket</titleabbrev>
<div class="paragraph">
<p>A sibling pipeline aggregation which calculates the (mean) average value of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
</div>
<div class="sect3">
<h4 id="avg-bucket-agg-syntax">Syntax</h4>
<div class="paragraph">
<p>An <code>avg_bucket</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "avg_bucket": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="avg-bucket-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 38. <code>avg_bucket</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to find the average for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the average of the total monthly <code>sales</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "avg_monthly_sales": {
      "avg_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <b class="conum">(1)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this avg_bucket aggregation that we want the (mean) average value of the <code>sales</code> aggregation in the
<code>sales_per_month</code> date histogram.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "avg_monthly_sales": {
          "value": 328.33333333333333
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-bucket-script-aggregation">Bucket script aggregation</h3>
<titleabbrev>Bucket script</titleabbrev>
<div class="paragraph">
<p>A parent pipeline aggregation which executes a script which can perform per bucket computations on specified metrics
in the parent multi-bucket aggregation. The specified metric must be numeric and the script must return a numeric value.</p>
</div>
<div class="sect3">
<h4 id="bucket-script-agg-syntax">Syntax</h4>
<div class="paragraph">
<p>A <code>bucket_script</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "bucket_script": {
    "buckets_path": {
      "my_var1": "the_sum",                     <b class="conum">(1)</b>
      "my_var2": "the_value_count"
    },
    "script": "params.my_var1 / params.my_var2"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here, <code>my_var1</code> is the name of the variable for this buckets path to use in the script, <code>the_sum</code> is the path to
the metrics to use for that variable.</p>
</li>
</ol>
</div>
<table id="bucket-script-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 39. <code>bucket_script</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>script</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The script to run for this aggregation. The script can be inline, file or indexed. (see <a href="modules-scripting.html">Scripting</a>
for more details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map of script variables and their associated path to the buckets we wish to use for the variable
(see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the ratio percentage of t-shirt sales compared to total sales each month:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        },
        "t-shirts": {
          "filter": {
            "term": {
              "type": "t-shirt"
            }
          },
          "aggs": {
            "sales": {
              "sum": {
                "field": "price"
              }
            }
          }
        },
        "t-shirt-percentage": {
          "bucket_script": {
            "buckets_path": {
              "tShirtSales": "t-shirts&gt;sales",
              "totalSales": "total_sales"
            },
            "script": "params.tShirtSales / params.totalSales * 100"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "total_sales": {
                   "value": 550.0
               },
               "t-shirts": {
                   "doc_count": 1,
                   "sales": {
                       "value": 200.0
                   }
               },
               "t-shirt-percentage": {
                   "value": 36.36363636363637
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "total_sales": {
                   "value": 60.0
               },
               "t-shirts": {
                   "doc_count": 1,
                   "sales": {
                       "value": 10.0
                   }
               },
               "t-shirt-percentage": {
                   "value": 16.666666666666664
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "total_sales": {
                   "value": 375.0
               },
               "t-shirts": {
                   "doc_count": 1,
                   "sales": {
                       "value": 175.0
                   }
               },
               "t-shirt-percentage": {
                   "value": 46.666666666666664
               }
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-bucket-selector-aggregation">Bucket selector aggregation</h3>
<titleabbrev>Bucket selector</titleabbrev>
<div class="paragraph">
<p>A parent pipeline aggregation which executes a script which determines whether the current bucket will be retained
in the parent multi-bucket aggregation. The specified metric must be numeric and the script must return a boolean value.
If the script language is <code>expression</code> then a numeric return value is permitted. In this case 0.0 will be evaluated as <code>false</code>
and all other values will evaluate to true.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The bucket_selector aggregation, like all pipeline aggregations, executes after all other sibling aggregations. This means that
using the bucket_selector aggregation to filter the returned buckets in the response does not save on execution time running the aggregations.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_syntax_2">Syntax</h4>
<div class="paragraph">
<p>A <code>bucket_selector</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "bucket_selector": {
    "buckets_path": {
      "my_var1": "the_sum",                     <b class="conum">(1)</b>
      "my_var2": "the_value_count"
    },
    "script": "params.my_var1 &gt; params.my_var2"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here, <code>my_var1</code> is the name of the variable for this buckets path to use in the script, <code>the_sum</code> is the path to
the metrics to use for that variable.</p>
</li>
</ol>
</div>
<table id="bucket-selector-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 40. <code>bucket_selector</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>script</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The script to run for this aggregation. The script can be inline, file or indexed. (see <a href="modules-scripting.html">Scripting</a>
for more details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map of script variables and their associated path to the buckets we wish to use for the variable
(see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet only retains buckets where the total sales for the month is more than 200:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_bucket_filter": {
          "bucket_selector": {
            "buckets_path": {
              "totalSales": "total_sales"
            },
            "script": "params.totalSales &gt; 200"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "total_sales": {
                   "value": 550.0
               }
            },<b class="conum">(1)</b>
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "total_sales": {
                   "value": 375.0
               },
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Bucket for <code>2015/02/01 00:00:00</code> has been removed as its total sales was less than 200</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-bucket-sort-aggregation">Bucket sort aggregation</h3>
<titleabbrev>Bucket sort</titleabbrev>
<div class="paragraph">
<p>A parent pipeline aggregation which sorts the buckets of its parent multi-bucket aggregation.
Zero or more sort fields may be specified together with the corresponding sort order.
Each bucket may be sorted based on its <code>_key</code>, <code>_count</code> or its sub-aggregations.
In addition, parameters <code>from</code> and <code>size</code> may be set in order to truncate the result buckets.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>bucket_sort</code> aggregation, like all pipeline aggregations, is executed after all other non-pipeline aggregations.
This means the sorting only applies to whatever buckets are already returned from the parent aggregation. For example,
if the parent aggregation is <code>terms</code> and its <code>size</code> is set to <code>10</code>, the <code>bucket_sort</code> will only sort over those 10
returned term buckets.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_syntax_3">Syntax</h4>
<div class="paragraph">
<p>A <code>bucket_sort</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "bucket_sort": {
    "sort": [
      { "sort_field_1": { "order": "asc" } },   <b class="conum">(1)</b>
      { "sort_field_2": { "order": "desc" } },
      "sort_field_3"
    ],
    "from": 1,
    "size": 3
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here, <code>sort_field_1</code> is the bucket path to the variable to be used as the primary sort and its order
is ascending.</p>
</li>
</ol>
</div>
<table id="bucket-sort-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 41. <code>bucket_sort</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The list of fields to sort on. See <a href="sort-search-results.html"><code>sort</code></a> for more details.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>from</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Buckets in positions prior to the set value will be truncated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of buckets to return. Defaults to all buckets of the parent aggregation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet returns the buckets corresponding to the 3 months with the highest total sales in descending order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_bucket_sort": {
          "bucket_sort": {
            "sort": [
              { "total_sales": { "order": "desc" } } <b class="conum">(1)</b>
            ],
            "size": 3                                <b class="conum">(2)</b>
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>sort</code> is set to use the values of <code>total_sales</code> in descending order</p>
</li>
<li>
<p><code>size</code> is set to <code>3</code> meaning only the top 3 months in <code>total_sales</code> will be returned</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 82,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "total_sales": {
                   "value": 550.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "total_sales": {
                   "value": 375.0
               },
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "total_sales": {
                   "value": 60.0
               },
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_truncating_without_sorting">Truncating without sorting</h4>
<div class="paragraph">
<p>It is also possible to use this aggregation in order to truncate the result buckets
without doing any sorting. To do so, just use the <code>from</code> and/or <code>size</code> parameters
without specifying <code>sort</code>.</p>
</div>
<div class="paragraph">
<p>The following example simply truncates the result so that only the second bucket is returned:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "bucket_truncate": {
          "bucket_sort": {
            "from": 1,
            "size": 1
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-cumulative-sum-aggregation">Cumulative sum aggregation</h3>
<titleabbrev>Cumulative sum</titleabbrev>
<div class="paragraph">
<p>A parent pipeline aggregation which calculates the cumulative sum of a specified metric in a parent histogram (or date_histogram)
aggregation. The specified metric must be numeric and the enclosing histogram must have <code>min_doc_count</code> set to <code>0</code> (default
for <code>histogram</code> aggregations).</p>
</div>
<div class="sect3">
<h4 id="_syntax_4">Syntax</h4>
<div class="paragraph">
<p>A <code>cumulative_sum</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "cumulative_sum": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="cumulative-sum-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 42. <code>cumulative_sum</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to find the cumulative sum for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the cumulative sum of the total monthly <code>sales</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "cumulative_sales": {
          "cumulative_sum": {
            "buckets_path": "sales" <b class="conum">(1)</b>
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this cumulative sum aggregation to use the output of the <code>sales</code> aggregation for the cumulative sum</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               },
               "cumulative_sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "cumulative_sales": {
                  "value": 610.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "cumulative_sales": {
                  "value": 985.0
               }
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-derivative-aggregation">Derivative aggregation</h3>
<titleabbrev>Derivative</titleabbrev>
<div class="paragraph">
<p>A parent pipeline aggregation which calculates the derivative of a specified metric in a parent histogram (or date_histogram)
aggregation. The specified metric must be numeric and the enclosing histogram must have <code>min_doc_count</code> set to <code>0</code> (default
for <code>histogram</code> aggregations).</p>
</div>
<div class="sect3">
<h4 id="_syntax_5">Syntax</h4>
<div class="paragraph">
<p>A <code>derivative</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">"derivative": {
  "buckets_path": "the_sum"
}</code></pre>
</div>
</div>
<table id="derivative-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 43. <code>derivative</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to find the derivative for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_first_order_derivative">First Order Derivative</h4>
<div class="paragraph">
<p>The following snippet calculates the derivative of the total monthly <code>sales</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_deriv": {
          "derivative": {
            "buckets_path": "sales" <b class="conum">(1)</b>
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this derivative aggregation to use the output of the <code>sales</code> aggregation for the derivative</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <b class="conum">(1)</b>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0 <b class="conum">(2)</b>
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2, <b class="conum">(3)</b>
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0
               }
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>No derivative for the first bucket since we need at least 2 data points to calculate the derivative</p>
</li>
<li>
<p>Derivative value units are implicitly defined by the <code>sales</code> aggregation and the parent histogram so in this case the units
would be $/month assuming the <code>price</code> field has units of $.</p>
</li>
<li>
<p>The number of documents in the bucket are represented by the <code>doc_count</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_second_order_derivative">Second Order Derivative</h4>
<div class="paragraph">
<p>A second order derivative can be calculated by chaining the derivative pipeline aggregation onto the result of another derivative
pipeline aggregation as in the following example which will calculate both the first and the second order derivative of the total
monthly sales:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_deriv": {
          "derivative": {
            "buckets_path": "sales"
          }
        },
        "sales_2nd_deriv": {
          "derivative": {
            "buckets_path": "sales_deriv" <b class="conum">(1)</b>
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> for the second derivative points to the name of the first derivative</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 50,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <b class="conum">(1)</b>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0
               } <b class="conum">(1)</b>
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0
               },
               "sales_2nd_deriv": {
                  "value": 805.0
               }
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>No second derivative for the first two buckets since we need at least 2 data points from the first derivative to calculate the
second derivative</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_units">Units</h4>
<div class="paragraph">
<p>The derivative aggregation allows the units of the derivative values to be specified. This returns an extra field in the response
<code>normalized_value</code> which reports the derivative value in the desired x-axis units.  In the below example we calculate the derivative
of the total sales per month but ask for the derivative of the sales as in the units of sales per day:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        },
        "sales_deriv": {
          "derivative": {
            "buckets_path": "sales",
            "unit": "day" <b class="conum">(1)</b>
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>unit</code> specifies what unit to use for the x-axis of the derivative calculation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 50,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               } <b class="conum">(1)</b>
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               },
               "sales_deriv": {
                  "value": -490.0, <b class="conum">(1)</b>
                  "normalized_value": -15.806451612903226 <b class="conum">(2)</b>
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               },
               "sales_deriv": {
                  "value": 315.0,
                  "normalized_value": 11.25
               }
            }
         ]
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>value</code> is reported in the original units of 'per month'</p>
</li>
<li>
<p><code>normalized_value</code> is reported in the desired units of 'per day'</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-extended-stats-bucket-aggregation">Extended stats bucket aggregation</h3>
<titleabbrev>Extended stats bucket</titleabbrev>
<div class="paragraph">
<p>A sibling pipeline aggregation which calculates a variety of stats across all bucket of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
</div>
<div class="paragraph">
<p>This aggregation provides a few more statistics (sum of squares, standard deviation, etc) compared to the <code>stats_bucket</code> aggregation.</p>
</div>
<div class="sect3">
<h4 id="_syntax_6">Syntax</h4>
<div class="paragraph">
<p>A <code>extended_stats_bucket</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "extended_stats_bucket": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="extended-stats-bucket-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 44. <code>extended_stats_bucket</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to calculate stats for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sigma</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of standard deviations above/below the mean to display</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the extended stats for monthly <code>sales</code> bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "stats_monthly_sales": {
      "extended_stats_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <b class="conum">(1)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>bucket_paths</code> instructs this <code>extended_stats_bucket</code> aggregation that we want the calculate stats for the <code>sales</code> aggregation in the
<code>sales_per_month</code> date histogram.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "stats_monthly_sales": {
         "count": 3,
         "min": 60.0,
         "max": 550.0,
         "avg": 328.3333333333333,
         "sum": 985.0,
         "sum_of_squares": 446725.0,
         "variance": 41105.55555555556,
         "variance_population": 41105.55555555556,
         "variance_sampling": 61658.33333333334,
         "std_deviation": 202.74505063146563,
         "std_deviation_population": 202.74505063146563,
         "std_deviation_sampling": 248.3109609609156,
         "std_deviation_bounds": {
           "upper": 733.8234345962646,
           "lower": -77.15676792959795,
           "upper_population" : 733.8234345962646,
           "lower_population" : -77.15676792959795,
           "upper_sampling" : 824.9552552551645,
           "lower_sampling" : -168.28858858849787
         }
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-max-bucket-aggregation">Max bucket aggregation</h3>
<titleabbrev>Max bucket</titleabbrev>
<div class="paragraph">
<p>A sibling pipeline aggregation which identifies the bucket(s) with the maximum value of a specified metric in a sibling aggregation
and outputs both the value and the key(s) of the bucket(s). The specified metric must be numeric and the sibling aggregation must
be a multi-bucket aggregation.</p>
</div>
<div class="sect3">
<h4 id="_syntax_7">Syntax</h4>
<div class="paragraph">
<p>A <code>max_bucket</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "max_bucket": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="max-bucket-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 45. <code>max_bucket</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to find the maximum for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the maximum of the total monthly <code>sales</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "max_monthly_sales": {
      "max_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <b class="conum">(1)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this max_bucket aggregation that we want the maximum value of the <code>sales</code> aggregation in the
<code>sales_per_month</code> date histogram.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "max_monthly_sales": {
          "keys": ["2015/01/01 00:00:00"], <b class="conum">(1)</b>
          "value": 550.0
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>keys</code> is an array of strings since the maximum value may be present in multiple buckets</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-min-bucket-aggregation">Min bucket aggregation</h3>
<titleabbrev>Min bucket</titleabbrev>
<div class="paragraph">
<p>A sibling pipeline aggregation which identifies the bucket(s) with the minimum value of a specified metric in a sibling aggregation
and outputs both the value and the key(s) of the bucket(s). The specified metric must be numeric and the sibling aggregation must
be a multi-bucket aggregation.</p>
</div>
<div class="sect3">
<h4 id="_syntax_8">Syntax</h4>
<div class="paragraph">
<p>A <code>min_bucket</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "min_bucket": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="min-bucket-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 46. <code>min_bucket</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to find the minimum for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the minimum of the total monthly <code>sales</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "min_monthly_sales": {
      "min_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <b class="conum">(1)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this min_bucket aggregation that we want the minimum value of the <code>sales</code> aggregation in the
<code>sales_per_month</code> date histogram.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "min_monthly_sales": {
          "keys": ["2015/02/01 00:00:00"], <b class="conum">(1)</b>
          "value": 60.0
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>keys</code> is an array of strings since the minimum value may be present in multiple buckets</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-movavg-aggregation">Moving average aggregation</h3>
<titleabbrev>Moving average</titleabbrev>
<div class="paragraph">
<p>The Moving Average aggregation has been deprecated in favor of the more general <a href="search-aggregations-pipeline.html#search-aggregations-pipeline-movfn-aggregation">Moving Function Aggregation</a>.  The new Moving Function aggregation provides all the same functionality as the Moving Average aggregation, but also provides more flexibility.</p>
</div>
<div class="paragraph">
<p>Given an ordered series of data, the Moving Average aggregation will slide a window across the data and emit the average
value of that window.  For example, given the data <code>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code>, we can calculate a simple moving
average with windows size of <code>5</code> as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(1 + 2 + 3 + 4 + 5) / 5  = 3</p>
</li>
<li>
<p>(2 + 3 + 4 + 5 + 6) / 5  = 4</p>
</li>
<li>
<p>(3 + 4 + 5 + 6 + 7) / 5 = 5</p>
</li>
<li>
<p>etc</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Moving averages are a simple method to smooth sequential data.  Moving averages are typically applied to time-based data,
such as stock prices or server metrics.  The smoothing can be used to eliminate high frequency fluctuations or random noise,
which allows the lower frequency trends to be more easily visualized, such as seasonality.</p>
</div>
<div class="sect3">
<h4 id="_syntax_9">Syntax</h4>
<div class="paragraph">
<p>A <code>moving_avg</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "moving_avg": {
    "buckets_path": "the_sum",
    "model": "holt",
    "window": 5,
    "gap_policy": "insert_zeros",
    "settings": {
      "alpha": 0.8
    }
  }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 47. <code>moving_avg</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the metric of interest (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>model</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The moving average weighting model that we wish to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data. See <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>window</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of window to "slide" across the histogram.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>5</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>minimize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the model should be algorithmically minimized.  See <a href="search-aggregations-pipeline.html#movavg-minimizer">Minimization</a> for more
 details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code> for most models</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>settings</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Model-specific settings, contents which differ depending on the model specified.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>moving_avg</code> aggregations must be embedded inside of a <code>histogram</code> or <code>date_histogram</code> aggregation.  They can be
embedded like any other metric aggregation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {                                <b class="conum">(1)</b>
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }                 <b class="conum">(2)</b>
        },
        "the_movavg": {
          "moving_avg": { "buckets_path": "the_sum" } <b class="conum">(3)</b>
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A <code>date_histogram</code> named "my_date_histo" is constructed on the "timestamp" field, with one-day intervals</p>
</li>
<li>
<p>A <code>sum</code> metric is used to calculate the sum of a field.  This could be any metric (sum, min, max, etc)</p>
</li>
<li>
<p>Finally, we specify a <code>moving_avg</code> aggregation which uses "the_sum" metric as its input.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Moving averages are built by first specifying a <code>histogram</code> or <code>date_histogram</code> over a field.  You can then optionally
add normal metrics, such as a <code>sum</code>, inside of that histogram.  Finally, the <code>moving_avg</code> is embedded inside the histogram.
The <code>buckets_path</code> parameter is then used to "point" at one of the sibling metrics inside of the histogram (see
<a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for a description of the syntax for <code>buckets_path</code>.</p>
</div>
<div class="paragraph">
<p>An example response from the above aggregation may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "took": 11,
  "timed_out": false,
  "_shards": ...,
  "hits": ...,
  "aggregations": {
    "my_date_histo": {
      "buckets": [
        {
          "key_as_string": "2015/01/01 00:00:00",
          "key": 1420070400000,
          "doc_count": 3,
          "the_sum": {
            "value": 550.0
          }
        },
        {
          "key_as_string": "2015/02/01 00:00:00",
          "key": 1422748800000,
          "doc_count": 2,
          "the_sum": {
            "value": 60.0
          },
          "the_movavg": {
            "value": 550.0
          }
        },
        {
          "key_as_string": "2015/03/01 00:00:00",
          "key": 1425168000000,
          "doc_count": 2,
          "the_sum": {
            "value": 375.0
          },
          "the_movavg": {
            "value": 305.0
          }
        }
      ]
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_models">Models</h4>
<div class="paragraph">
<p>The <code>moving_avg</code> aggregation includes four different moving average "models".  The main difference is how the values in the
window are weighted.  As data-points become "older" in the window, they may be weighted differently.  This will
affect the final average for that window.</p>
</div>
<div class="paragraph">
<p>Models are specified using the <code>model</code> parameter.  Some models may have optional configurations which are specified inside
the <code>settings</code> parameter.</p>
</div>
<div class="sect4">
<h5 id="_simple">Simple</h5>
<div class="paragraph">
<p>The <code>simple</code> model calculates the sum of all values in the window, then divides by the size of the window.  It is effectively
a simple arithmetic mean of the window.  The simple model does not perform any time-dependent weighting, which means
the values from a <code>simple</code> moving average tend to "lag" behind the real data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "simple"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>simple</code> model has no special settings to configure</p>
</div>
<div class="paragraph">
<p>The window size can change the behavior of the moving average.  For example, a small window (<code>"window": 10</code>) will closely
track the data and only smooth out small scale fluctuations:</p>
</div>
<div id="movavg_10window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/movavg_10window.png" alt="movavg 10window">
</div>
<div class="title">Figure 3. Moving average with window of size 10</div>
</div>
<div class="paragraph">
<p>In contrast, a <code>simple</code> moving average with larger window (<code>"window": 100</code>) will smooth out all higher-frequency fluctuations,
leaving only low-frequency, long term trends.  It also tends to "lag" behind the actual data by a substantial amount:</p>
</div>
<div id="movavg_100window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/movavg_100window.png" alt="movavg 100window">
</div>
<div class="title">Figure 4. Moving average with window of size 100</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_linear">Linear</h4>
<div class="paragraph">
<p>The <code>linear</code> model assigns a linear weighting to points in the series, such that "older" datapoints (e.g. those at
the beginning of the window) contribute a linearly less amount to the total average.  The linear weighting helps reduce
the "lag" behind the data&#8217;s mean, since older points have less influence.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "linear"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>linear</code> model has no special settings to configure</p>
</div>
<div class="paragraph">
<p>Like the <code>simple</code> model, window size can change the behavior of the moving average.  For example, a small window (<code>"window": 10</code>)
will closely track the data and only smooth out small scale fluctuations:</p>
</div>
<div id="linear_10window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/linear_10window.png" alt="linear 10window">
</div>
<div class="title">Figure 5. Linear moving average with window of size 10</div>
</div>
<div class="paragraph">
<p>In contrast, a <code>linear</code> moving average with larger window (<code>"window": 100</code>) will smooth out all higher-frequency fluctuations,
leaving only low-frequency, long term trends.  It also tends to "lag" behind the actual data by a substantial amount,
although typically less than the <code>simple</code> model:</p>
</div>
<div id="linear_100window" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/linear_100window.png" alt="linear 100window">
</div>
<div class="title">Figure 6. Linear moving average with window of size 100</div>
</div>
</div>
<div class="sect3">
<h4 id="_ewma_exponentially_weighted">EWMA (Exponentially Weighted)</h4>
<div class="paragraph">
<p>The <code>ewma</code> model (aka "single-exponential") is similar to the <code>linear</code> model, except older data-points become exponentially less important,
rather than linearly less important.  The speed at which the importance decays can be controlled with an <code>alpha</code>
setting.  Small values make the weight decay slowly, which provides greater smoothing and takes into account a larger
portion of the window.  Larger values make the weight decay quickly, which reduces the impact of older values on the
moving average.  This tends to make the moving average track the data more closely but with less smoothing.</p>
</div>
<div class="paragraph">
<p>The default value of <code>alpha</code> is <code>0.3</code>, and the setting accepts any float from 0-1 inclusive.</p>
</div>
<div class="paragraph">
<p>The EWMA model can be <a href="search-aggregations-pipeline.html#movavg-minimizer">Minimized</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "ewma",
            "settings": {
              "alpha": 0.5
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div id="single_0.2alpha" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/single_0.2alpha.png" alt="single 0.2alpha">
</div>
<div class="title">Figure 7. EWMA with window of size 10, alpha = 0.2</div>
</div>
<div id="single_0.7alpha" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/single_0.7alpha.png" alt="single 0.7alpha">
</div>
<div class="title">Figure 8. EWMA with window of size 10, alpha = 0.7</div>
</div>
</div>
<div class="sect3">
<h4 id="_holt_linear">Holt-Linear</h4>
<div class="paragraph">
<p>The <code>holt</code> model (aka "double exponential") incorporates a second exponential term which
tracks the data&#8217;s trend.  Single exponential does not perform well when the data has an underlying linear trend.  The
double exponential model calculates two values internally: a "level" and a "trend".</p>
</div>
<div class="paragraph">
<p>The level calculation is similar to <code>ewma</code>, and is an exponentially weighted view of the data.  The difference is
that the previously smoothed value is used instead of the raw value, which allows it to stay close to the original series.
The trend calculation looks at the difference between the current and last value (e.g. the slope, or trend, of the
smoothed data).  The trend value is also exponentially weighted.</p>
</div>
<div class="paragraph">
<p>Values are produced by multiplying the level and trend components.</p>
</div>
<div class="paragraph">
<p>The default value of <code>alpha</code> is <code>0.3</code> and <code>beta</code> is <code>0.1</code>. The settings accept any float from 0-1 inclusive.</p>
</div>
<div class="paragraph">
<p>The Holt-Linear model can be <a href="search-aggregations-pipeline.html#movavg-minimizer">Minimized</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "holt",
            "settings": {
              "alpha": 0.5,
              "beta": 0.5
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In practice, the <code>alpha</code> value behaves very similarly in <code>holt</code> as <code>ewma</code>: small values produce more smoothing
and more lag, while larger values produce closer tracking and less lag.  The value of <code>beta</code> is often difficult
to see.  Small values emphasize long-term trends (such as a constant linear trend in the whole series), while larger
values emphasize short-term trends.  This will become more apparently when you are predicting values.</p>
</div>
<div id="double_0.2beta" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_0.2beta.png" alt="double 0.2beta">
</div>
<div class="title">Figure 9. Holt-Linear moving average with window of size 100, alpha = 0.5, beta = 0.2</div>
</div>
<div id="double_0.7beta" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_0.7beta.png" alt="double 0.7beta">
</div>
<div class="title">Figure 10. Holt-Linear moving average with window of size 100, alpha = 0.5, beta = 0.7</div>
</div>
</div>
<div class="sect3">
<h4 id="_holt_winters">Holt-Winters</h4>
<div class="paragraph">
<p>The <code>holt_winters</code> model (aka "triple exponential") incorporates a third exponential term which
tracks the seasonal aspect of your data.  This aggregation therefore smooths based on three components: "level", "trend"
and "seasonality".</p>
</div>
<div class="paragraph">
<p>The level and trend calculation is identical to <code>holt</code> The seasonal calculation looks at the difference between
the current point, and the point one period earlier.</p>
</div>
<div class="paragraph">
<p>Holt-Winters requires a little more handholding than the other moving averages.  You need to specify the "periodicity"
of your data: e.g. if your data has cyclic trends every 7 days, you would set <code>period: 7</code>.  Similarly if there was
a monthly trend, you would set it to <code>30</code>.  There is currently no periodicity detection, although that is planned
for future enhancements.</p>
</div>
<div class="paragraph">
<p>There are two varieties of Holt-Winters: additive and multiplicative.</p>
</div>
<div class="sect4">
<h5 id="_cold_start">"Cold Start"</h5>
<div class="paragraph">
<p>Unfortunately, due to the nature of Holt-Winters, it requires two periods of data to "bootstrap" the algorithm.  This
means that your <code>window</code> must always be <strong>at least</strong> twice the size of your period.  An exception will be thrown if it
isn&#8217;t.  It also means that Holt-Winters will not emit a value for the first <code>2 * period</code> buckets; the current algorithm
does not backcast.</p>
</div>
<div id="holt_winters_cold_start" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/triple_untruncated.png" alt="triple untruncated">
</div>
<div class="title">Figure 11. Holt-Winters showing a "cold" start where no values are emitted</div>
</div>
<div class="paragraph">
<p>Because the "cold start" obscures what the moving average looks like, the rest of the Holt-Winters images are truncated
to not show the "cold start".  Just be aware this will always be present at the beginning of your moving averages!</p>
</div>
</div>
<div class="sect4">
<h5 id="_additive_holt_winters">Additive Holt-Winters</h5>
<div class="paragraph">
<p>Additive seasonality is the default; it can also be specified by setting <code>"type": "add"</code>.  This variety is preferred
when the seasonal affect is additive to your data. E.g. you could simply subtract the seasonal effect to "de-seasonalize"
your data into a flat trend.</p>
</div>
<div class="paragraph">
<p>The default values of <code>alpha</code> and <code>gamma</code> are <code>0.3</code> while <code>beta</code> is <code>0.1</code>.  The settings accept any float from 0-1 inclusive.
The default value of <code>period</code> is <code>1</code>.</p>
</div>
<div class="paragraph">
<p>The additive Holt-Winters model can be <a href="search-aggregations-pipeline.html#movavg-minimizer">Minimized</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "holt_winters",
            "settings": {
              "type": "add",
              "alpha": 0.5,
              "beta": 0.5,
              "gamma": 0.5,
              "period": 7
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div id="holt_winters_add" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/triple.png" alt="triple">
</div>
<div class="title">Figure 12. Holt-Winters moving average with window of size 120, alpha = 0.5, beta = 0.7, gamma = 0.3, period = 30</div>
</div>
</div>
<div class="sect4">
<h5 id="_multiplicative_holt_winters">Multiplicative Holt-Winters</h5>
<div class="paragraph">
<p>Multiplicative is specified by setting <code>"type": "mult"</code>.  This variety is preferred when the seasonal affect is
multiplied against your data. E.g. if the seasonal affect is x5 the data, rather than simply adding to it.</p>
</div>
<div class="paragraph">
<p>The default values of <code>alpha</code> and <code>gamma</code> are <code>0.3</code> while <code>beta</code> is <code>0.1</code>.  The settings accept any float from 0-1 inclusive.
The default value of <code>period</code> is <code>1</code>.</p>
</div>
<div class="paragraph">
<p>The multiplicative Holt-Winters model can be <a href="search-aggregations-pipeline.html#movavg-minimizer">Minimized</a></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Multiplicative Holt-Winters works by dividing each data point by the seasonal value.  This is problematic if any of
your data is zero, or if there are gaps in the data (since this results in a divid-by-zero).  To combat this, the
<code>mult</code> Holt-Winters pads all values by a very small amount (1*10<sup>-10</sup>) so that all values are non-zero.  This affects
the result, but only minimally.  If your data is non-zero, or you prefer to see <code>NaN</code> when zero&#8217;s are encountered,
you can disable this behavior with <code>pad: false</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "holt_winters",
            "settings": {
              "type": "mult",
              "alpha": 0.5,
              "beta": 0.5,
              "gamma": 0.5,
              "period": 7,
              "pad": true
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_prediction">Prediction</h4>
<div class="paragraph">
<p>experimental[]</p>
</div>
<div class="paragraph">
<p>All the moving average model support a "prediction" mode, which will attempt to extrapolate into the future given the
current smoothed, moving average.  Depending on the model and parameter, these predictions may or may not be accurate.</p>
</div>
<div class="paragraph">
<p>Predictions are enabled by adding a <code>predict</code> parameter to any moving average aggregation, specifying the number of
predictions you would like appended to the end of the series.  These predictions will be spaced out at the same interval
as your buckets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "window": 30,
            "model": "simple",
            "predict": 10
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>simple</code>, <code>linear</code> and <code>ewma</code> models all produce "flat" predictions: they essentially converge on the mean
of the last value in the series, producing a flat:</p>
</div>
<div id="simple_prediction" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/simple_prediction.png" alt="simple prediction">
</div>
<div class="title">Figure 13. Simple moving average with window of size 10, predict = 50</div>
</div>
<div class="paragraph">
<p>In contrast, the <code>holt</code> model can extrapolate based on local or global constant trends.  If we set a high <code>beta</code>
value, we can extrapolate based on local constant trends (in this case the predictions head down, because the data at the end
of the series was heading in a downward direction):</p>
</div>
<div id="double_prediction_local" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_prediction_local.png" alt="double prediction local">
</div>
<div class="title">Figure 14. Holt-Linear moving average with window of size 100, predict = 20, alpha = 0.5, beta = 0.8</div>
</div>
<div class="paragraph">
<p>In contrast, if we choose a small <code>beta</code>, the predictions are based on the global constant trend.  In this series, the
global trend is slightly positive, so the prediction makes a sharp u-turn and begins a positive slope:</p>
</div>
<div id="double_prediction_global" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/double_prediction_global.png" alt="double prediction global">
</div>
<div class="title">Figure 15. Double Exponential moving average with window of size 100, predict = 20, alpha = 0.5, beta = 0.1</div>
</div>
<div class="paragraph">
<p>The <code>holt_winters</code> model has the potential to deliver the best predictions, since it also incorporates seasonal
fluctuations into the model:</p>
</div>
<div id="holt_winters_prediction_global" class="imageblock">
<div class="content">
<img src="images/pipeline_movavg/triple_prediction.png" alt="triple prediction">
</div>
<div class="title">Figure 16. Holt-Winters moving average with window of size 120, predict = 25, alpha = 0.8, beta = 0.2, gamma = 0.7, period = 30</div>
</div>
</div>
<div class="sect3">
<h4 id="movavg-minimizer">Minimization</h4>
<div class="paragraph">
<p>Some of the models (EWMA, Holt-Linear, Holt-Winters) require one or more parameters to be configured.  Parameter choice
can be tricky and sometimes non-intuitive.  Furthermore, small deviations in these parameters can sometimes have a drastic
effect on the output moving average.</p>
</div>
<div class="paragraph">
<p>For that reason, the three "tunable" models can be algorithmically <strong>minimized</strong>.  Minimization is a process where parameters
are tweaked until the predictions generated by the model closely match the output data.  Minimization is not fullproof
and can be susceptible to overfitting, but it often gives better results than hand-tuning.</p>
</div>
<div class="paragraph">
<p>Minimization is disabled by default for <code>ewma</code> and <code>holt_linear</code>, while it is enabled by default for <code>holt_winters</code>.
Minimization is most useful with Holt-Winters, since it helps improve the accuracy of the predictions.  EWMA and
Holt-Linear are not great predictors, and mostly used for smoothing data, so minimization is less useful on those
models.</p>
</div>
<div class="paragraph">
<p>Minimization is enabled/disabled via the <code>minimize</code> parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_avg": {
            "buckets_path": "the_sum",
            "model": "holt_winters",
            "window": 30,
            "minimize": true,  <b class="conum">(1)</b>
            "settings": {
              "period": 7
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Minimization is enabled with the <code>minimize</code> parameter</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When enabled, minimization will find the optimal values for <code>alpha</code>, <code>beta</code> and <code>gamma</code>.  The user should still provide
appropriate values for <code>window</code>, <code>period</code> and <code>type</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Minimization works by running a stochastic process called <strong>simulated annealing</strong>.  This process will usually generate
a good solution, but is not guaranteed to find the global optimum.  It also requires some amount of additional
computational power, since the model needs to be re-run multiple times as the values are tweaked.  The run-time of
minimization is linear to the size of the window being processed: excessively large windows may cause latency.</p>
</div>
<div class="paragraph">
<p>Finally, minimization fits the model to the last <code>n</code> values, where <code>n = window</code>.  This generally produces
better forecasts into the future, since the parameters are tuned around the end of the series.  It can, however, generate
poorer fitting moving averages at the beginning of the series.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-movfn-aggregation">Moving function aggregation</h3>
<titleabbrev>Moving function</titleabbrev>
<div class="paragraph">
<p>Given an ordered series of data, the Moving Function aggregation will slide a window across the data and allow the user to specify a custom
script that is executed on each window of data.  For convenience, a number of common functions are predefined such as min/max, moving averages,
etc.</p>
</div>
<div class="paragraph">
<p>This is conceptually very similar to the <a href="search-aggregations-pipeline.html#search-aggregations-pipeline-movavg-aggregation">Moving Average</a> pipeline aggregation, except
it provides more functionality.</p>
</div>
<div class="sect3">
<h4 id="_syntax_10">Syntax</h4>
<div class="paragraph">
<p>A <code>moving_fn</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "moving_fn": {
    "buckets_path": "the_sum",
    "window": 10,
    "script": "MovingFunctions.min(values)"
  }
}</code></pre>
</div>
</div>
<table id="moving-fn-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 48. <code>moving_fn</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the metric of interest (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>window</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of window to "slide" across the histogram.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>script</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The script that should be executed on each window of data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data. See <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shift</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="search-aggregations-pipeline.html#shift-parameter">Shift</a> of window position.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>moving_fn</code> aggregations must be embedded inside of a <code>histogram</code> or <code>date_histogram</code> aggregation.  They can be
embedded like any other metric aggregation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {                  <b class="conum">(1)</b>
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }   <b class="conum">(2)</b>
        },
        "the_movfn": {
          "moving_fn": {
            "buckets_path": "the_sum",  <b class="conum">(3)</b>
            "window": 10,
            "script": "MovingFunctions.unweightedAvg(values)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A <code>date_histogram</code> named "my_date_histo" is constructed on the "timestamp" field, with one-day intervals</p>
</li>
<li>
<p>A <code>sum</code> metric is used to calculate the sum of a field.  This could be any numeric metric (sum, min, max, etc)</p>
</li>
<li>
<p>Finally, we specify a <code>moving_fn</code> aggregation which uses "the_sum" metric as its input.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Moving averages are built by first specifying a <code>histogram</code> or <code>date_histogram</code> over a field.  You can then optionally
add numeric metrics, such as a <code>sum</code>, inside of that histogram.  Finally, the <code>moving_fn</code> is embedded inside the histogram.
The <code>buckets_path</code> parameter is then used to "point" at one of the sibling metrics inside of the histogram (see
<a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for a description of the syntax for <code>buckets_path</code>.</p>
</div>
<div class="paragraph">
<p>An example response from the above aggregation may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "my_date_histo": {
         "buckets": [
             {
                 "key_as_string": "2015/01/01 00:00:00",
                 "key": 1420070400000,
                 "doc_count": 3,
                 "the_sum": {
                    "value": 550.0
                 },
                 "the_movfn": {
                    "value": null
                 }
             },
             {
                 "key_as_string": "2015/02/01 00:00:00",
                 "key": 1422748800000,
                 "doc_count": 2,
                 "the_sum": {
                    "value": 60.0
                 },
                 "the_movfn": {
                    "value": 550.0
                 }
             },
             {
                 "key_as_string": "2015/03/01 00:00:00",
                 "key": 1425168000000,
                 "doc_count": 2,
                 "the_sum": {
                    "value": 375.0
                 },
                 "the_movfn": {
                    "value": 305.0
                 }
             }
         ]
      }
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_custom_user_scripting">Custom user scripting</h4>
<div class="paragraph">
<p>The Moving Function aggregation allows the user to specify any arbitrary script to define custom logic.  The script is invoked each time a
new window of data is collected.  These values are provided to the script in the <code>values</code> variable.  The script should then perform some
kind of calculation and emit a single <code>double</code> as the result.  Emitting <code>null</code> is not permitted, although <code>NaN</code> and +/- <code>Inf</code> are allowed.</p>
</div>
<div class="paragraph">
<p>For example, this script will simply return the first value from the window, or <code>NaN</code> if no values are available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "return values.length &gt; 0 ? values[0] : Double.NaN"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="shift-parameter">shift parameter</h4>
<div class="paragraph">
<p>By default (with <code>shift = 0</code>), the window that is offered for calculation is the last <code>n</code> values excluding the current bucket.
Increasing <code>shift</code> by 1 moves starting window position by <code>1</code> to the right.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To include current bucket to the window, use <code>shift = 1</code>.</p>
</li>
<li>
<p>For center alignment (<code>n / 2</code> values before and after the current bucket), use <code>shift = window / 2</code>.</p>
</li>
<li>
<p>For right alignment (<code>n</code> values after the current bucket), use <code>shift = window</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If either of window edges moves outside the borders of data series, the window shrinks to include available values only.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pre_built_functions">Pre-built Functions</h4>
<div class="paragraph">
<p>For convenience, a number of functions have been prebuilt and are available inside the <code>moving_fn</code> script context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>max()</code></p>
</li>
<li>
<p><code>min()</code></p>
</li>
<li>
<p><code>sum()</code></p>
</li>
<li>
<p><code>stdDev()</code></p>
</li>
<li>
<p><code>unweightedAvg()</code></p>
</li>
<li>
<p><code>linearWeightedAvg()</code></p>
</li>
<li>
<p><code>ewma()</code></p>
</li>
<li>
<p><code>holt()</code></p>
</li>
<li>
<p><code>holtWinters()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The functions are available from the <code>MovingFunctions</code> namespace.  E.g. <code>MovingFunctions.max()</code></p>
</div>
<div class="sect4">
<h5 id="_max_function">max Function</h5>
<div class="paragraph">
<p>This function accepts a collection of doubles and returns the maximum value in that window. <code>null</code> and <code>NaN</code> values are ignored; the maximum
is only calculated over the real values. If the window is empty, or all values are <code>null</code>/<code>NaN</code>, <code>NaN</code> is returned as the result.</p>
</div>
<table id="max-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 49. <code>max(double[] values)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the maximum</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_max": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.max(values)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_min_function">min Function</h5>
<div class="paragraph">
<p>This function accepts a collection of doubles and returns the minimum value in that window.  <code>null</code> and <code>NaN</code> values are ignored; the minimum
is only calculated over the real values. If the window is empty, or all values are <code>null</code>/<code>NaN</code>, <code>NaN</code> is returned as the result.</p>
</div>
<table id="min-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 50. <code>min(double[] values)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the minimum</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_min": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.min(values)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sum_function">sum Function</h5>
<div class="paragraph">
<p>This function accepts a collection of doubles and returns the sum of the values in that window.  <code>null</code> and <code>NaN</code> values are ignored;
the sum is only calculated over the real values.  If the window is empty, or all values are <code>null</code>/<code>NaN</code>, <code>0.0</code> is returned as the result.</p>
</div>
<table id="sum-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 51. <code>sum(double[] values)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the sum of</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_sum": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.sum(values)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_stddev_function">stdDev Function</h5>
<div class="paragraph">
<p>This function accepts a collection of doubles and average, then returns the standard deviation of the values in that window.
<code>null</code> and <code>NaN</code> values are ignored; the sum is only calculated over the real values.  If the window is empty, or all values are
<code>null</code>/<code>NaN</code>, <code>0.0</code> is returned as the result.</p>
</div>
<table id="stddev-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 52. <code>stdDev(double[] values)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the standard deviation of</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>avg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The average of the window</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_moving_sum": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.stdDev(values, MovingFunctions.unweightedAvg(values))"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>avg</code> parameter must be provided to the standard deviation function because different styles of averages can be computed on the window
(simple, linearly weighted, etc).  The various moving averages that are detailed below can be used to calculate the average for the
standard deviation function.</p>
</div>
</div>
<div class="sect4">
<h5 id="_unweightedavg_function">unweightedAvg Function</h5>
<div class="paragraph">
<p>The <code>unweightedAvg</code> function calculates the sum of all values in the window, then divides by the size of the window.  It is effectively
a simple arithmetic mean of the window.  The simple moving average does not perform any time-dependent weighting, which means
the values from a <code>simple</code> moving average tend to "lag" behind the real data.</p>
</div>
<div class="paragraph">
<p><code>null</code> and <code>NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code>null</code>/<code>NaN</code>, <code>NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code>null</code>,non-<code>NaN</code>
values.</p>
</div>
<table id="unweightedavg-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 53. <code>unweightedAvg(double[] values)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the sum of</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.unweightedAvg(values)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_linearweightedavg_function">linearWeightedAvg Function</h4>
<div class="paragraph">
<p>The <code>linearWeightedAvg</code> function assigns a linear weighting to points in the series, such that "older" datapoints (e.g. those at
the beginning of the window) contribute a linearly less amount to the total average.  The linear weighting helps reduce
the "lag" behind the data&#8217;s mean, since older points have less influence.</p>
</div>
<div class="paragraph">
<p>If the window is empty, or all values are <code>null</code>/<code>NaN</code>, <code>NaN</code> is returned as the result.</p>
</div>
<table id="linearweightedavg-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 54. <code>linearWeightedAvg(double[] values)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the sum of</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.linearWeightedAvg(values)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ewma_function">ewma Function</h4>
<div class="paragraph">
<p>The <code>ewma</code> function (aka "single-exponential") is similar to the <code>linearMovAvg</code> function,
except older data-points become exponentially less important,
rather than linearly less important.  The speed at which the importance decays can be controlled with an <code>alpha</code>
setting.  Small values make the weight decay slowly, which provides greater smoothing and takes into account a larger
portion of the window.  Larger values make the weight decay quickly, which reduces the impact of older values on the
moving average.  This tends to make the moving average track the data more closely but with less smoothing.</p>
</div>
<div class="paragraph">
<p><code>null</code> and <code>NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code>null</code>/<code>NaN</code>, <code>NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code>null</code>,non-<code>NaN</code>
values.</p>
</div>
<table id="ewma-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 55. <code>ewma(double[] values, double alpha)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the sum of</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>alpha</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exponential decay</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.ewma(values, 0.3)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_holt_function">holt Function</h4>
<div class="paragraph">
<p>The <code>holt</code> function (aka "double exponential") incorporates a second exponential term which
tracks the data&#8217;s trend.  Single exponential does not perform well when the data has an underlying linear trend.  The
double exponential model calculates two values internally: a "level" and a "trend".</p>
</div>
<div class="paragraph">
<p>The level calculation is similar to <code>ewma</code>, and is an exponentially weighted view of the data.  The difference is
that the previously smoothed value is used instead of the raw value, which allows it to stay close to the original series.
The trend calculation looks at the difference between the current and last value (e.g. the slope, or trend, of the
smoothed data).  The trend value is also exponentially weighted.</p>
</div>
<div class="paragraph">
<p>Values are produced by multiplying the level and trend components.</p>
</div>
<div class="paragraph">
<p><code>null</code> and <code>NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code>null</code>/<code>NaN</code>, <code>NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code>null</code>,non-<code>NaN</code>
values.</p>
</div>
<table id="holt-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 56. <code>holt(double[] values, double alpha)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the sum of</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>alpha</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Level decay value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beta</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trend decay value</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "MovingFunctions.holt(values, 0.3, 0.1)"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In practice, the <code>alpha</code> value behaves very similarly in <code>holtMovAvg</code> as <code>ewmaMovAvg</code>: small values produce more smoothing
and more lag, while larger values produce closer tracking and less lag.  The value of <code>beta</code> is often difficult
to see.  Small values emphasize long-term trends (such as a constant linear trend in the whole series), while larger
values emphasize short-term trends.</p>
</div>
</div>
<div class="sect3">
<h4 id="_holtwinters_function">holtWinters Function</h4>
<div class="paragraph">
<p>The <code>holtWinters</code> function (aka "triple exponential") incorporates a third exponential term which
tracks the seasonal aspect of your data.  This aggregation therefore smooths based on three components: "level", "trend"
and "seasonality".</p>
</div>
<div class="paragraph">
<p>The level and trend calculation is identical to <code>holt</code> The seasonal calculation looks at the difference between
the current point, and the point one period earlier.</p>
</div>
<div class="paragraph">
<p>Holt-Winters requires a little more handholding than the other moving averages.  You need to specify the "periodicity"
of your data: e.g. if your data has cyclic trends every 7 days, you would set <code>period = 7</code>.  Similarly if there was
a monthly trend, you would set it to <code>30</code>.  There is currently no periodicity detection, although that is planned
for future enhancements.</p>
</div>
<div class="paragraph">
<p><code>null</code> and <code>NaN</code> values are ignored; the average is only calculated over the real values. If the window is empty, or all values are
<code>null</code>/<code>NaN</code>, <code>NaN</code> is returned as the result.  This means that the count used in the average calculation is count of non-<code>null</code>,non-<code>NaN</code>
values.</p>
</div>
<table id="holtwinters-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 57. <code>holtWinters(double[] values, double alpha)</code> Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>values</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The window of values to find the sum of</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>alpha</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Level decay value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beta</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trend decay value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gamma</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seasonality decay value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>period</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The periodicity of the data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multiplicative</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if you wish to use multiplicative holt-winters, false to use additive</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
  "size": 0,
  "aggs": {
    "my_date_histo": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "the_sum": {
          "sum": { "field": "price" }
        },
        "the_movavg": {
          "moving_fn": {
            "buckets_path": "the_sum",
            "window": 10,
            "script": "if (values.length &gt; 5*2) {MovingFunctions.holtWinters(values, 0.3, 0.1, 0.1, 5, false)}"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Multiplicative Holt-Winters works by dividing each data point by the seasonal value.  This is problematic if any of
your data is zero, or if there are gaps in the data (since this results in a divid-by-zero).  To combat this, the
<code>mult</code> Holt-Winters pads all values by a very small amount (1*10<sup>-10</sup>) so that all values are non-zero.  This affects
the result, but only minimally.  If your data is non-zero, or you prefer to see <code>NaN</code> when zero&#8217;s are encountered,
you can disable this behavior with <code>pad: false</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_cold_start_2">"Cold Start"</h5>
<div class="paragraph">
<p>Unfortunately, due to the nature of Holt-Winters, it requires two periods of data to "bootstrap" the algorithm.  This
means that your <code>window</code> must always be <strong>at least</strong> twice the size of your period.  An exception will be thrown if it
isn&#8217;t.  It also means that Holt-Winters will not emit a value for the first <code>2 * period</code> buckets; the current algorithm
does not backcast.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll notice in the above example we have an <code>if ()</code> statement checking the size of values.  This is checking to make sure
we have two periods worth of data (<code>5 * 2</code>, where 5 is the period specified in the <code>holtWintersMovAvg</code> function) before calling
the holt-winters function.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-percentiles-bucket-aggregation">Percentiles bucket aggregation</h3>
<titleabbrev>Percentiles bucket</titleabbrev>
<div class="paragraph">
<p>A sibling pipeline aggregation which calculates percentiles across all bucket of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
</div>
<div class="sect3">
<h4 id="_syntax_11">Syntax</h4>
<div class="paragraph">
<p>A <code>percentiles_bucket</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "percentiles_bucket": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="percentiles-bucket-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 58. <code>percentiles_bucket</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to find the percentiles for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>percents</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The list of percentiles to calculate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[ 1, 5, 25, 50, 75, 95, 99 ]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keyed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag which returns the range as an hash instead of an array of key-value pairs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the percentiles for the total monthly <code>sales</code> buckets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "percentiles_monthly_sales": {
      "percentiles_bucket": {
        "buckets_path": "sales_per_month&gt;sales", <b class="conum">(1)</b>
        "percents": [ 25.0, 50.0, 75.0 ]         <b class="conum">(2)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this percentiles_bucket aggregation that we want to calculate percentiles for
the <code>sales</code> aggregation in the <code>sales_per_month</code> date histogram.</p>
</li>
<li>
<p><code>percents</code> specifies which percentiles we wish to calculate, in this case, the 25th, 50th and 75th percentiles.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "percentiles_monthly_sales": {
        "values" : {
            "25.0": 375.0,
            "50.0": 375.0,
            "75.0": 550.0
         }
      }
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_percentiles_bucket_implementation">Percentiles_bucket implementation</h4>
<div class="paragraph">
<p>The Percentile Bucket returns the nearest input data point that is not greater than the requested percentile; it does not
interpolate between data points.</p>
</div>
<div class="paragraph">
<p>The percentiles are calculated exactly and is not an approximation (unlike the Percentiles Metric). This means
the implementation maintains an in-memory, sorted list of your data to compute the percentiles, before discarding the
data.  You may run into memory pressure issues if you attempt to calculate percentiles over many millions of
data-points in a single <code>percentiles_bucket</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-serialdiff-aggregation">Serial differencing aggregation</h3>
<titleabbrev>Serial differencing</titleabbrev>
<div class="paragraph">
<p>Serial differencing is a technique where values in a time series are subtracted from itself at
different time lags or periods. For example, the datapoint f(x) = f(x<sub>t</sub>) - f(x<sub>t-n</sub>), where n is the period being used.</p>
</div>
<div class="paragraph">
<p>A period of 1 is equivalent to a derivative with no time normalization: it is simply the change from one point to the
next. Single periods are useful for removing constant, linear trends.</p>
</div>
<div class="paragraph">
<p>Single periods are also useful for transforming data into a stationary series. In this example, the Dow Jones is
plotted over ~250 days. The raw data is not stationary, which would make it difficult to use with some techniques.</p>
</div>
<div class="paragraph">
<p>By calculating the first-difference, we de-trend the data (e.g. remove a constant, linear trend).  We can see that the
data becomes a stationary series (e.g. the first difference is randomly distributed around zero, and doesn&#8217;t seem to
exhibit any pattern/behavior). The transformation reveals that the dataset is following a random-walk; the value is the
previous value +/- a random amount.  This insight allows selection of further tools for analysis.</p>
</div>
<div id="serialdiff_dow" class="imageblock">
<div class="content">
<img src="images/pipeline_serialdiff/dow.png" alt="dow">
</div>
<div class="title">Figure 17. Dow Jones plotted and made stationary with first-differencing</div>
</div>
<div class="paragraph">
<p>Larger periods can be used to remove seasonal / cyclic behavior. In this example, a population of lemmings was
synthetically generated with a sine wave + constant linear trend + random noise. The sine wave has a period of 30 days.</p>
</div>
<div class="paragraph">
<p>The first-difference removes the constant trend, leaving just a sine wave. The 30th-difference is then applied to the
first-difference to remove the cyclic behavior, leaving a stationary series which is amenable to other analysis.</p>
</div>
<div id="serialdiff_lemmings" class="imageblock">
<div class="content">
<img src="images/pipeline_serialdiff/lemmings.png" alt="lemmings">
</div>
<div class="title">Figure 18. Lemmings data plotted made stationary with 1st and 30th difference</div>
</div>
<div class="sect3">
<h4 id="_syntax_12">Syntax</h4>
<div class="paragraph">
<p>A <code>serial_diff</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "serial_diff": {
    "buckets_path": "the_sum",
    "lag": "7"
  }
}</code></pre>
</div>
</div>
<table id="serial-diff-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 59. <code>serial_diff</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to the metric of interest (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lag</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The historical bucket to subtract from the current value. E.g. a lag of 7 will subtract the current value from
 the value 7 buckets ago. Must be a positive, non-zero integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines what should happen when a gap in the data is encountered.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>insert_zero</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>serial_diff</code> aggregations must be embedded inside of a <code>histogram</code> or <code>date_histogram</code> aggregation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /_search
{
   "size": 0,
   "aggs": {
      "my_date_histo": {                  <b class="conum">(1)</b>
         "date_histogram": {
            "field": "timestamp",
            "calendar_interval": "day"
         },
         "aggs": {
            "the_sum": {
               "sum": {
                  "field": "lemmings"     <b class="conum">(2)</b>
               }
            },
            "thirtieth_difference": {
               "serial_diff": {                <b class="conum">(3)</b>
                  "buckets_path": "the_sum",
                  "lag" : 30
               }
            }
         }
      }
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A <code>date_histogram</code> named "my_date_histo" is constructed on the "timestamp" field, with one-day intervals</p>
</li>
<li>
<p>A <code>sum</code> metric is used to calculate the sum of a field.  This could be any metric (sum, min, max, etc)</p>
</li>
<li>
<p>Finally, we specify a <code>serial_diff</code> aggregation which uses "the_sum" metric as its input.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Serial differences are built by first specifying a <code>histogram</code> or <code>date_histogram</code> over a field.  You can then optionally
add normal metrics, such as a <code>sum</code>, inside of that histogram.  Finally, the <code>serial_diff</code> is embedded inside the histogram.
The <code>buckets_path</code> parameter is then used to "point" at one of the sibling metrics inside of the histogram (see
<a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for a description of the syntax for <code>buckets_path</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-stats-bucket-aggregation">Stats bucket aggregation</h3>
<titleabbrev>Stats bucket</titleabbrev>
<div class="paragraph">
<p>A sibling pipeline aggregation which calculates a variety of stats across all bucket of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
</div>
<div class="sect3">
<h4 id="_syntax_13">Syntax</h4>
<div class="paragraph">
<p>A <code>stats_bucket</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "stats_bucket": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="stats-bucket-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 60. <code>stats_bucket</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to calculate stats for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the stats for monthly <code>sales</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "stats_monthly_sales": {
      "stats_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <b class="conum">(1)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>bucket_paths</code> instructs this <code>stats_bucket</code> aggregation that we want the calculate stats for the <code>sales</code> aggregation in the
<code>sales_per_month</code> date histogram.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "stats_monthly_sales": {
         "count": 3,
         "min": 60.0,
         "max": 550.0,
         "avg": 328.3333333333333,
         "sum": 985.0
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="search-aggregations-pipeline-sum-bucket-aggregation">Sum bucket aggregation</h3>
<titleabbrev>Sum bucket</titleabbrev>
<div class="paragraph">
<p>A sibling pipeline aggregation which calculates the sum across all buckets of a specified metric in a sibling aggregation.
The specified metric must be numeric and the sibling aggregation must be a multi-bucket aggregation.</p>
</div>
<div class="sect3">
<h4 id="_syntax_14">Syntax</h4>
<div class="paragraph">
<p>A <code>sum_bucket</code> aggregation looks like this in isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">{
  "sum_bucket": {
    "buckets_path": "the_sum"
  }
}</code></pre>
</div>
</div>
<table id="sum-bucket-params" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 61. <code>sum_bucket</code> Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buckets_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the buckets we wish to find the sum for (see <a href="search-aggregations-pipeline.html#buckets-path-syntax"><code>buckets_path</code> Syntax</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gap_policy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The policy to apply when gaps are found in the data (see <a href="search-aggregations-pipeline.html#gap-policy">Dealing with gaps in the data</a> for more
 details)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>format</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format to apply to the output value of this aggregation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following snippet calculates the sum of all the total monthly <code>sales</code> buckets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">POST /sales/_search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "sum_monthly_sales": {
      "sum_bucket": {
        "buckets_path": "sales_per_month&gt;sales" <b class="conum">(1)</b>
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>buckets_path</code> instructs this sum_bucket aggregation that we want the sum of the <code>sales</code> aggregation in the
<code>sales_per_month</code> date histogram.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And the following may be the response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console-result" data-lang="console-result">{
   "took": 11,
   "timed_out": false,
   "_shards": ...,
   "hits": ...,
   "aggregations": {
      "sales_per_month": {
         "buckets": [
            {
               "key_as_string": "2015/01/01 00:00:00",
               "key": 1420070400000,
               "doc_count": 3,
               "sales": {
                  "value": 550.0
               }
            },
            {
               "key_as_string": "2015/02/01 00:00:00",
               "key": 1422748800000,
               "doc_count": 2,
               "sales": {
                  "value": 60.0
               }
            },
            {
               "key_as_string": "2015/03/01 00:00:00",
               "key": 1425168000000,
               "doc_count": 2,
               "sales": {
                  "value": 375.0
               }
            }
         ]
      },
      "sum_monthly_sales": {
          "value": 985.0
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>Previous:<a href="search-aggregations-metrics.html">Metrics aggregations</a>| Up:<a href="search-aggregations.html">Aggregations</a>| Home:<a href="index.html">OpenSearch Reference</a>| Next:<a href="modules-scripting.html">Scripting</a></p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-12 14:08:20 -0700
</div>
</div>
</body>
</html>